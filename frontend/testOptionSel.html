<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>추천 시스템</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        flex-direction: column;
        margin: 20px;
        padding-top: 90px;
        background-color: #f2f2f2;
        text-align: center;
      }

      .option-section {
        display: none;
        text-align: center;
        margin: auto;
      }

      .option-box {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 10px;
        max-width: 600px;
        margin: auto;
        background-color: white;
      }

      .option-section.active {
        display: block;
      }
      .recommendation-item {
        display: inline-block;
        margin: 10px;
        text-align: center;
      }
      .recommendation-item img {
        width: 150px;
        height: 200px;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 5px;
      }
      .recommendation-item img.selected {
        border-color: blue;
        box-shadow: 0 0 10px rgba(0, 0, 255, 0.5);
      }
      .gender-option {
        display: flex; /* 성별 옵션을 가로로 정렬 */
        justify-content: center;
        margin-top: 20px;
        font-size: 18px;
      }
      .gender-option div {
        margin: 0 20px; /* 항목 간의 간격 설정 */
        display: flex;
        flex-direction: column; /* 세로 방향으로 정렬 */
        align-items: center; /* 가운데 정렬 */
      }
      .genderImage {
        width: 250px;
        height: auto;
      }
      .gender-option input {
        margin-top: 10px;
      }
      select {
        margin-left: 10px;
      }
      /* 키 몸무게 입력 옵션 */
      .phyInfo {
        text-align: right; /* 오른쪽 정렬 */
        width: 300px;
        height: 70px;
        margin: 0 auto; /* 전체 가운데 정렬 */
        margin-top: 20px;
      }
      #height,
      #weight {
        text-align: left; /* 입력란 내용 가운데 정렬 */
      }
      .inputInterval {
        margin: 20px auto;
      }
      .optionSelbutton {
        background-color: #d3d3d3;
        color: black;
        padding: 10px 20px;
        margin: 20px 20px 20px 20px;
        cursor: pointer;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div id="nav-container"></div>
    <!-- 동적으로 nav.html 삽입 -->

    <h2>추천 옵션 선택</h2>
    <!-- 옵션 선택 박스 추가 -->
    <div class="option-box">
      <form id="optionsForm">
        <!-- 사용자 정보 입력 -->
        <div class="option-section active" id="genderSection">
          <h3>성별 선택</h3>
          <div class="gender-option">
            <label for="gender">성별:</label>
            <select id="gender" required>
              <option value="">선택</option>
              <option value="male">남자</option>
              <option value="female">여자</option>
            </select>
          </div>

          <br />
          <button
            type="button"
            class="optionSelbutton"
            onclick="nextSection('heightWeightSection')"
          >
            다음
          </button>
        </div>

        <div class="option-section" id="heightWeightSection">
          <h3>키와 몸무게 입력</h3>
          <div class="phyInfo">
            <label for="height">키 (cm):</label>
            <input type="number" id="height" required />
            <br />
            <p></p>
            <label for="weight">몸무게 (kg):</label>
            <input type="number" id="weight" required />
            <br />
          </div>
          <p></p>
          <button
            type="button"
            class="optionSelbutton"
            onclick="nextSection('styleSection')"
          >
            다음
          </button>
          <button
            type="button"
            class="optionSelbutton"
            onclick="previousSection('genderSection')"
          >
            뒤로가기
          </button>
        </div>

        <div class="option-section" id="styleSection">
          <h3>스타일 선택</h3>
          <label for="style" class="inputInterval">스타일:</label>
          <select id="style" required>
            <option value="">선택</option>
            <option value="캐주얼">캐주얼</option>
            <option value="스트릿">스트릿</option>
            <option value="미니멀">미니멀</option>
            <option value="워크웨이">워크웨이</option>
          </select>
          <br />
          <button
            type="button"
            class="optionSelbutton"
            onclick="nextSection('recommendationOrderSection')"
          >
            다음
          </button>
          <button
            type="button"
            class="optionSelbutton"
            onclick="previousSection('heightWeightSection')"
          >
            뒤로가기
          </button>
        </div>

        <div class="option-section" id="recommendationOrderSection">
          <h3>추천 시작 항목 선택</h3>
          <label for="recommendationOrder">추천 시작 항목:</label>
          <select id="recommendationOrder" required>
            <option value="">선택</option>
            <option value="상의">상의</option>
            <option value="하의">하의</option>
          </select>
          <br />
          <button
            type="button"
            class="optionSelbutton"
            onclick="startRecommendation()"
          >
            추천받기 시작
          </button>
          <button
            type="button"
            class="optionSelbutton"
            onclick="previousSection('styleSection')"
          >
            뒤로가기
          </button>
        </div>

        <!-- 추천 결과 -->
        <div class="option-section" id="recommendationSection">
          <h3>추천 결과</h3>
          <div id="recommendationResults"></div>
          <button
            type="button"
            class="optionSelbutton"
            onclick="confirmSelection()"
          >
            다음 단계
          </button>
          <button type="button" class="optionSelbutton" onclick="restart()">
            다시 시작
          </button>
          <button
            type="button"
            class="optionSelbutton"
            onclick="previousSection('recommendationOrderSection')"
          >
            뒤로가기
          </button>
        </div>

        <!-- 최종 결과 -->
        <div class="option-section" id="finalSection">
          <h3>최종 세트</h3>
          <div id="finalResults"></div>
          <button type="button" class="optionSelbutton" onclick="restart()">
            다시 시작
          </button>
          <button
            type="button"
            class="optionSelbutton"
            onclick="goToClothingSet()"
          >
            결과 보기
          </button>
        </div>
      </form>
    </div>

    <script>
      let userInfo = {}; // 사용자 정보 저장
      let selectedTop = null; // 선택한 상의 ID
      let selectedBottom = null; // 선택한 하의 ID
      let isTopFirst = true; // 추천 시작 순서 판단

      function showSection(sectionId) {
        document.querySelectorAll(".option-section").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");
      }

      function nextSection(nextSectionId) {
        // 각 입력값 유효성 검사
        if (nextSectionId === "heightWeightSection") {
          const gender = document.getElementById("gender").value;
          if (!gender) {
            alert("성별을 선택해주세요.");
            return;
          }
        } else if (nextSectionId === "styleSection") {
          const height = document.getElementById("height").value;
          const weight = document.getElementById("weight").value;
          if (!height || !weight) {
            alert("키와 몸무게를 입력해주세요.");
            return;
          }
        } else if (nextSectionId === "recommendationOrderSection") {
          const style = document.getElementById("style").value;
          if (!style) {
            alert("스타일을 선택해주세요.");
            return;
          }
        }

        showSection(nextSectionId);
      }

      function previousSection(previousSectionId) {
        showSection(previousSectionId);
      }

      function startRecommendation() {
        const gender = document.getElementById("gender").value;
        const height = document.getElementById("height").value;
        const weight = document.getElementById("weight").value;
        const style = document.getElementById("style").value;
        const recommendationOrder = document.getElementById(
          "recommendationOrder"
        ).value;

        if (!gender || !height || !weight || !style || !recommendationOrder) {
          alert("모든 정보를 입력해주세요.");
          return;
        }

        // 사용자 정보를 저장
        userInfo = { gender, height, weight, style, recommendationOrder };

        // 선택한 순서에 따라 추천 시작
        requestRecommendation(recommendationOrder);
      }

      async function requestRecommendation(type) {
        const token = localStorage.getItem("token");
        const user_id = token
          ? parseInt(localStorage.getItem("user_id"), 10)
          : null; // user_id를 localStorage에서 가져옴
        const payload = {
          user_id: user_id,
          gender: userInfo.gender,
          height: parseInt(userInfo.height, 10),
          weight: parseInt(userInfo.weight, 10),
          style: userInfo.style,
          clothingType: type,
        };

        console.log("Payload sent to the server:", payload); // 확인용 로그

        try {
          const aiResponse = await fetch(
            "http://khs.uy.to:8000/api/recommend",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!aiResponse.ok) {
            const errorMessage = await aiResponse.text();
            console.error("추천 요청 실패:", errorMessage);
            alert(`추천 요청 실패: ${errorMessage}`);
            return;
          }

          const aiData = await aiResponse.json();
          console.log("추천 결과:", aiData);

          if (aiData.recommendations.length > 0) {
            displayRecommendations(aiData.recommendations, type); // 추천 데이터 표시
          } else {
            alert("추천 결과가 없습니다.");
          }
        } catch (error) {
          console.error("추천 요청 중 오류 발생:", error.message);
          alert("추천 요청 중 오류 발생.");
        }
      }

      function displayRecommendations(items, type) {
        const container = document.getElementById("recommendationResults");
        container.innerHTML = items
          .map(
            (item) => `
                  <div class="recommendation-item" onclick="selectItem('${type}', '${item.id}')">
                    <img src="${item.이미지_URL}" alt="${item.id}" />
                    <p>${item.상품명}</p>
                  </div>`
          )
          .join("");

        showSection("recommendationSection");
      }

      function selectItem(type, id) {
        // 기존 선택 상태 초기화
        document.querySelectorAll(".recommendation-item img").forEach((img) => {
          img.classList.remove("selected");
        });

        // 선택한 항목 강조 표시
        const selectedImage = document.querySelector(
          `.recommendation-item img[alt="${id}"]`
        );
        if (selectedImage) {
          selectedImage.classList.add("selected");

          // 선택한 아이템 ID 저장
          if (type === "상의") {
            selectedTop = id;
            userInfo.recommendationOrder = "하의"; // 다음 추천은 하의
            console.log("Selected Top ID:", selectedTop);
          } else if (type === "하의") {
            selectedBottom = id;
            userInfo.recommendationOrder = "상의"; // 다음 추천은 상의
            console.log("Selected Bottom ID:", selectedBottom);
          }
        } else {
          console.error("선택한 항목을 찾을 수 없습니다.");
        }
      }

      function confirmSelection() {
        if (isTopFirst) {
          // 상의를 먼저 추천받은 경우
          if (!selectedTop) {
            alert("먼저 상의를 선택해주세요.");
            return;
          }
          if (!selectedBottom) {
            console.log("상의 선택 완료. 하의 추천 시작.");
            requestRecommendation("하의");
          } else {
            showFinalResults();
          }
        } else {
          // 하의를 먼저 추천받은 경우
          if (!selectedBottom) {
            alert("먼저 하의를 선택해주세요.");
            return;
          }
          if (!selectedTop) {
            console.log("하의 선택 완료. 상의 추천 시작.");
            requestRecommendation("상의");
          } else {
            showFinalResults();
          }
        }
      }

      function showFinalResults() {
        if (!selectedTop && !selectedBottom) {
          alert("상의와 하의를 모두 선택해주세요.");
          return;
        }

        const container = document.getElementById("finalResults");
        container.innerHTML = `
          <p><strong>선택한 상의 ID:</strong> ${selectedTop}</p>
          <p><strong>선택한 하의 ID:</strong> ${selectedBottom}</p>
          `;
        showSection("finalSection");
      }

      function restart() {
        userInfo = {};
        selectedTop = null;
        selectedBottom = null;
        isTopFirst = true;
        showSection("genderSection");
      }

      function goToClothingSet() {
        if (!selectedTop && !selectedBottom) {
          alert("상의와 하의를 모두 선택해주세요.");
          return;
        }

        const url = `clothing_set.html?top=${"encodeURIComponent(selectedTop)"}&bottom=${encodeURIComponent(
          selectedBottom
        )}&gender=${encodeURIComponent(
          userInfo.gender
        )}&height=${encodeURIComponent(
          userInfo.height
        )}&weight=${encodeURIComponent(
          userInfo.weight
        )}&style=${encodeURIComponent(userInfo.style)};
        window.location.href = url`;
      }
    </script>

    <!--JS-->
    <script src="js/navbar.js" defer></script>
  </body>
</html>
