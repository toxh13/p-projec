<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>내스타일 - 스타일 추천 시스템</title>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous" ></script>
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet" />

    <link href="css/styles.css" rel="stylesheet" />
    <!-- 기본 스타일시트 -->
    <style>
      body {
        display: flex;
        align-items: center;
        flex-direction: column;
        font-family: Arial, sans-serif;
        padding-top: 90px;
      }

      h2 {
        padding-bottom: 20px;
      }

      #preset-container {
        display: flex;
        flex-direction: column; /* 프리셋을 수직으로 정렬 */
        gap: 30px; /* 프리셋 간 간격 추가 */
      }

      .preset {
        display: flex;
        flex-direction: row; /* 개별 프리셋 내부의 콘텐츠는 수평 정렬 */
        align-items: flex-start; /* 콘텐츠 상단 정렬 */
        gap: 30px; /* 내부 콘텐츠 간 간격 추가 */
        border: 1px solid #ddd; /* 각 프리셋에 경계선 추가 */
        padding: 20px;
        border-radius: 10px; /* 둥근 모서리 추가 */
        background-color: #f9f9f9; /* 배경색 추가 */
      }

      .clothing-info {
        display: flex;
        flex-direction: column; /* 상품 데이터를 수직 정렬 */
        flex: 3; /* 텍스트 영역 비율을 더 넓게 설정 */
        gap: 15px;
      }

      .clothing-info .item {
        display: flex;
        align-items: flex-start;
        gap: 20px;
      }
      .item div {
        display: grid;
        grid-template-rows: 1fr 1fr;
        font-size: 20px;
        margin-bottom: 30px;
      }

      .clothing-info img {
        width: 250px; /* 이미지 크기 조정 */
        height: auto; /* 비율 유지 */
        border-radius: 5px;
        flex-shrink: 0; /* 이미지가 텍스트에 의해 줄어들지 않도록 설정 */
      }

      .details-box {
        flex-grow: 1;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        background-color: #fff; /* 세부 정보 배경 흰색 */
        display: none; /* 기본 숨김 */
        margin: 0; /* 외부 여백 제거 */
        align-self: stretch; /* 상위 요소의 높이에 맞춰 확장 */
      }

      .button-container {
        display: flex;
        flex-direction: column; /* 버튼을 수직 정렬 */
        gap: 10px; /* 버튼 간 간격 추가 */
      }

      .button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px; /* 버튼 크기 조정 */
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px; /* 텍스트 크기 조정 */
        text-align: center;
      }

      .button:hover {
        background-color: #0056b3;
      }

      .delete-button {
        background-color: #dc3545;
      }

      .delete-button:hover {
        background-color: #a71d2a;
      }

      .modal {
        display: none; /* 기본적으로 모달은 숨김 */
        position: fixed; /* 화면에 고정 위치 */
        z-index: 1; /* 다른 요소 위에 표시 */
        left: 0; /* 왼쪽 끝에 정렬 */
        top: 0; /* 상단 끝에 정렬 */
        width: 100%; /* 전체 너비 */
        height: 100%; /* 전체 높이 */
        background-color: rgba(0, 0, 0, 0.5); /* 배경을 반투명하게 설정 */
      }

      .modal-content {
        background-color: #fff; /* 모달 콘텐츠 배경색 */
        margin: 15% auto; /* 위쪽 여백 및 가운데 정렬 */
        padding: 20px; /* 내부 여백 */
        border: 1px solid #888; /* 경계선 */
        width: 300px; /* 모달 너비 */
      }

      .close {
        color: #aaa; /* 닫기 버튼 색상 */
        float: right; /* 오른쪽 정렬 */
        font-size: 28px; /* 글자 크기 */
        font-weight: bold; /* 글자 두께 */
      }

      .close:hover,
      .close:focus {
        color: black; /* 호버 또는 포커스 시 색상 변경 */
        text-decoration: none; /* 밑줄 제거 */
        cursor: pointer; /* 커서 포인터로 변경 */
      }
    </style>
  </head>

  <body>
    <div id="nav-container"></div>
    <!-- 동적 네비게이션 바를 위한 컨테이너 -->
    <h2>내 스타일 - 저장된 프리셋</h2>

    <!-- 페이지 제목 -->
    <div id="preset-container"></div>
    <!-- 프리셋 아이템을 표시할 컨테이너 -->

    <!-- 모달 구조 -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <!-- 모달 닫기 버튼 -->
        <div id="modal-details"></div>
        <!-- 세부 정보를 표시할 공간 -->
      </div>
    </div>
    <script>
      // DOMContentLoaded 이벤트 리스너를 추가하여 페이지가 로드되면 fetchPresets 함수 호출
      document.addEventListener("DOMContentLoaded", () => {
        fetchPresets(); // 프리셋 데이터 가져오기
      });

      // 프리셋 데이터를 가져오는 함수
      function fetchPresets() {
        const token = localStorage.getItem("token"); // 로컬 스토리지에서 토큰 가져오기
        if (!token) {
          alert("로그인이 필요합니다."); // 토큰이 없으면 로그인 경고
          window.location.href = "/login.html"; // 로그인 페이지로 리다이렉트
          return;
        }

        // API 요청
        fetch("http://khs.uy.to:3000/api/clothing_presets", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`, // 인증 헤더 설정
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP 상태 코드: ${response.status}`); // 오류 처리
            }
            return response.json(); // JSON으로 변환
          })
          .then((data) => {
            const presets = Array.isArray(data) ? data : data.data; // 프리셋 데이터 배열
            if (!presets || presets.length === 0) {
              renderNoPresets(); // 프리셋이 없을 경우 처리
              return;
            }
            renderPresets(presets); // 프리셋 렌더링
          })
          .catch((error) => {
            console.error("프리셋 데이터를 가져오는 중 오류:", error); // 오류 로그
            alert(`프리셋을 불러오는 중 오류가 발생했습니다: ${error.message}`); // 오류 알림
          });
      }

      // 프리셋 데이터를 렌더링하는 함수
      function renderPresets(presets) {
        const container = document.getElementById("preset-container"); // 프리셋 컨테이너 선택

        // 프리셋을 HTML로 변환하여 컨테이너에 추가
        container.innerHTML = presets
          .map(
            (preset) => `
              <div class="preset">
                  <div class="clothing-info">
                      <div class="item">
                          <img src="${
                            preset.top_image_url || "#"
                          }" alt="상의 이미지" />
                          <div>
                              <div><strong>상품명:</strong> ${
                                preset.top_name || "정보 없음"
                              }</div>
                              <div><strong>브랜드:</strong> ${
                                preset.top_brand || "정보 없음"
                              }</div>
                              <div><strong>구매링크:</strong> ${
                                preset.top_purchase_link || "정보 없음"
                              }</div>
                          </div>
                      </div>
                      <div class="item">
                          <img src="${
                            preset.bottom_image_url || "#"
                          }" alt="하의 이미지" />
                          <div>
                              <div><strong>상품명:</strong> ${
                                preset.bottom_name || "정보 없음"
                              }</div>
                              <div><strong>브랜드:</strong> ${
                                preset.bottom_brand || "정보 없음"
                              }</div>
                              <div><strong>구매링크:</strong> ${
                                preset.bottom_purchase_link || "정보 없음"
                              }</div>
                          </div>
                      </div>
                      <button class="button" onclick="showDetails(${
                        preset.user_closet_id
                      }, '${preset.style}', ${preset.height}, ${
              preset.weight
            }, '${preset.sex}')">세부정보</button>
                      <button class="button delete-button" onclick="deletePreset(${
                        preset.user_closet_id
                      })">삭제</button>
                  </div>
              </div>`
          )
          .join("");
      }

      // 세부 정보를 모달로 표시하는 함수
      function showDetails(userClosetId, style, height, weight, sex) {
        const modalDetails = document.getElementById("modal-details"); // 모달 세부 정보 선택
        modalDetails.innerHTML = `
              <h3>세부 정보</h3>
              <p><strong>스타일:</strong> ${style}</p>
              <p><strong>키:</strong> ${height}cm</p>
              <p><strong>몸무게:</strong> ${weight}kg</p>
              <p><strong>성별:</strong> ${sex}</p>
          `;
        document.getElementById("modal").style.display = "block"; // 모달 열기
      }

      // 모달 닫기 버튼 클릭 시
      document.getElementById("closeModal").onclick = function () {
        document.getElementById("modal").style.display = "none"; // 모달 닫기
      };

      // 모달 외부 클릭 시 닫기
      window.onclick = function (event) {
        const modal = document.getElementById("modal");
        if (event.target === modal) {
          modal.style.display = "none"; // 모달 닫기
        }
      };

      // 프리셋이 없을 때 렌더링
      function renderNoPresets() {
        const container = document.getElementById("preset-container");
        container.innerHTML = "<p>저장된 프리셋이 없습니다.</p>";
      }

      // 삭제 API 호출 후 UI에서 삭제된 프리셋을 제거
      function deletePreset(userClosetId) {
        if (confirm("정말로 삭제하시겠습니까?")) {
          const token = localStorage.getItem("token");
          fetch(`http://khs.uy.to:3000/api/user_closets/${userClosetId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `삭제 실패 (HTTP 상태 코드: ${response.status})`
                );
              }
              alert("프리셋이 삭제되었습니다.");
              window.location.reload(); // 페이지 새로고침
            })
            .catch((error) => {
              console.error("삭제 중 오류 발생:", error);
              alert("삭제 중 오류가 발생했습니다.");
            });
        }
      }
    </script>

    <!--JS-->
    <script src="js/navbar.js" defer></script>
    <!--네비게이션바 기능-->
    <script src="js/mypreset.js" defer></script>
    <!-- 모달 기능을 위한 JS 파일 -->
  </body>
</html>
